log:
  level: warn
  production: true
  file: "/var/log/mosdns.log"

plugins:
  # ç¼“å­˜ä¼˜åŒ–
  - tag: "cache"
    type: cache
    args:
      size: 32768
      lazy_cache_ttl: 86400
      dump_file: "/var/db/mosdns.cache"
      dump_interval: 300

  # PTR åå‘è§£æ
  - tag: "reverse_lookup"
    type: reverse_lookup
    args:
      size: 5000
      ttl: 14400
      handle_ptr: true

  # å¢ƒå¤–åŸŸåé›†
  - tag: "remote_domain_set"
    type: domain_set
    args:
      files:
        - "./domains/gfw.txt"
        - "./domains/proxy-list.txt"

  # å›½å†…åŸŸåé›†
  - tag: "direct_domain_set"
    type: domain_set
    args:
      files:
        - "./domains/direct-list.txt"

  # å›½å†… IP é›†
  - tag: "direct_ip"
    type: ip_set
    args:
      files:
        - "./ips/all_cn.txt"

  # æœ¬åœ°è¿è¥å•† DNSï¼ˆUnbound æˆ– ISPï¼‰
  - tag: "local_forward"
    type: forward
    args:
      upstreams:
        - tag: local_dns
          addr: "udp://114.114.114.114"  # å¯æ¢æˆä½ å®é™…è¿è¥å•† DNS

  # ğŸš€ è¿œç¨‹ DNSï¼ˆç» Clash ä»£ç†è½¬å‘ï¼‰
  - tag: "remote_forward"
    type: forward
    args:
      upstreams:
        - tag: google_doh
          addr: "https://dns.google/dns-query"
          socks5: "127.0.0.1:7891"
          idle_timeout: 10

        - tag: cloudflare_doh
          addr: "https://cloudflare-dns.com/dns-query"
          socks5: "127.0.0.1:7891"
          idle_timeout: 10

        - tag: quad9_doh
          addr: "https://dns.quad9.net/dns-query"
          socks5: "127.0.0.1:7891"
          idle_timeout: 10

        - tag: unbound_dns
          addr: "udp://127.0.0.1:5355"
          idle_timeout: 10

  # å›½å†… DNSï¼ˆDoTï¼‰
  - tag: "domestic_forward"
    type: forward
    args:
      upstreams:
        - tag: ali_dot
          addr: "tls://223.5.5.5"
          idle_timeout: 10
        - tag: tencent_dot
          addr: "tls://119.29.29.29"
          idle_timeout: 10

  # TTL æ§åˆ¶
  - tag: "ttl_sequence"
    type: sequence
    args:
      - exec: ttl 600-86400
      - exec: accept

  # å›½å†…è§£ææµç¨‹
  - tag: "domestic_sequence"
    type: sequence
    args:
      - exec: $domestic_forward
      - exec: goto ttl_sequence

  # å›½å¤–è§£ææµç¨‹
  - tag: "remote_sequence"
    type: sequence
    args:
      - exec: $remote_forward
      - matches: "resp_ip $direct_ip"
        exec: $domestic_forward
      - exec: goto ttl_sequence

  # æ™ºèƒ½ fallback
  - tag: "fallback"
    type: fallback
    args:
      primary: remote_sequence
      secondary: domestic_sequence
      threshold: 300
      always_standby: true

  # ä¸»è§£ææµç¨‹
  - tag: "main_sequence"
    type: sequence
    args:
      - exec: prefer_ipv4
      - exec: $cache
      - matches: has_resp
        exec: accept
      - exec: $reverse_lookup
      - matches: has_resp
        exec: accept
      - matches: "qname $remote_domain_set"
        exec: goto remote_sequence
      - matches: "qname $direct_domain_set"
        exec: goto domestic_sequence
      - exec: $fallback

  - tag: udp_server
    type: udp_server
    args:
      entry: main_sequence
      listen: :5335

  - tag: tcp_server
    type: tcp_server
    args:
      entry: main_sequence
      listen: :5335
